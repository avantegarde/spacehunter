<!DOCTYPE html>
<html>
<head>
    <meta charset=utf-8>
    <meta name=apple-mobile-web-app-capable content=yes>
    <meta name=apple-mobile-web-app-status-bar-style content=black>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, minimal-ui" />
    <title>SpaceHunter</title>
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <link type="image/x-icon" rel="shortcut icon" href="apple-touch-icon.png"/>
    <link rel="stylesheet" href="icons.css" type="text/css" media="all" />
    <link rel="stylesheet" href="style.css" type="text/css" media="all" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
</head>
<body>
<div id="game" class="clearfix">
    <div id="notif"></div>
    <!-- Header -->
    <div id="header" class="clearfix">
        <span class="toggle-inventory"><i class="icon-backpack"></i></span>
        <span class="toggle-shop"><i class="icon-potion"></i></span>
        <span id="level">Lvl: <span></span></span> |
        <span id="xp">XP: <span></span></span> |
        <span id="units">$<span></span></span>
        <span id="wparts"><i class="icon-weapon-parts"></i> <span></span></span>
        <span class="toggle-settings"><i class="icon-gear-a"></i></span>
    </div>
    <!-- Battleground -->
    <div id="battleground" class="clearfix"></div>
    <!-- Settings -->
    <div id="settings" class="clearfix">
        <span class="toggle-settings">x</span>
        <ul class="menu">
            <li><span class="toggle-fullscreen"><i class="icon-arrow-expand"></i> Fullscreen</span></li>
            <li><span id="game-reset"><i class="icon-trash-a"></i> Delete Character</span></li>
        </ul>
    </div>
    <!-- Inventory -->
    <div id="inventory" class="clearfix"></div>
    <!-- Upgrade Modal -->
    <div id="upgrade-modal" class="clearfix"></div>
    <!-- Shop -->
    <div id="shop" class="clearfix"></div>
    <!-- Character -->
    <div id="character" class="clearfix"></div>
</div><!-- #game -->

<!-- Start JS -->
<script>
$(document).ready(function() {
    /**
     * Random number between 2 integers
     * @param int, int
     */
    function randomIntFromInterval(min,max) {
        return Math.floor(Math.random()*(max-min+1)+min);
    }
    /**
     * Random Background Image
     */
    function randomBGimg() {
        var bgIMG = 'bg' + randomIntFromInterval(1,20);
        var bgURL = 'img/' + bgIMG + '.jpg';
        return bgURL;
    }
    /**
     * Random Elemental Choice
     */
    function randomElemental() {
        var elements = [
            'none',
            'water',
            'fire',
            'earth'
        ];
        var element = elements[Math.floor(Math.random() * elements.length)];
        return element;
    }
    /**
     * Random Rarity
     */
    function randomRarity() {
        var rares = [
            'basic',
            'rare'
        ];
        if (state.player.lvl > 24) {
            rares.push('legendary');
        }
        if (state.player.lvl > 49) {
            rares.push('exotic');
        }
        var rarity = rares[Math.floor(Math.random() * rares.length)];
        return rarity;
    }
    /**
     * Random Monster Name
     */
    function randomMonsterName() {
        var adjectives = ["little", "sea", "huge", "strange", "double", "prehistoric", "human", "marine", "hideous", "fabulous", "mythical", "terrible", "horrible", "moral", "headed", "eyed", "grotesque", "evil", "inhuman", "hopeful", "ugly", "winged", "fantastic", "giant", "mechanical", "imaginary", "like", "female", "savage", "frightful", "big", "mythological", "gigantic", "cruel", "antediluvian", "extinct", "ferocious", "eating", "green", "horrid", "supernatural", "fierce", "hairy", "maligned", "dangerous", "famous", "unnatural", "scary", "uncouth", "shapeless", "dreadful", "fearful", "headless", "cold", "baggy", "alien", "mighty", "bloodthirsty", "aquatic", "fearsome", "legendary", "unknown", "primeval", "sacred", "scaly", "hungry", "enormous", "loose", "unwieldy", "grim", "voracious", "fabled", "weird", "hybrid", "dead"];
        var nouns = ["ninja", "raven", "demon", "statue", "unicorn", "rainbows", "laser", "bunny", "captain", "nibblets", "cupcake", "carrot", "gnomes", "glitter", "potato", "salad", "toejam", "curtains", "beets", "toilet", "exorcism", "stick figures", "mermaid eggs", "sea barnacles", "dragons", "jellybeans", "snakes", "dolls", "bushes", "cookies", "apples", "ice cream", "ukulele", "kazoo", "banjo", "opera singer", "circus", "trampoline", "carousel", "carnival", "locomotive", "balloon", "mantis", "animator", "artisan", "artist", "colorist", "inker", "coppersmith", "director", "designer", "flatter", "stylist", "leadman", "limner", "model", "musician", "penciller", "producer", "scenographer", "decorator", "silversmith", "teacher", "mechanic", "beader", "clerk", "attendant", "foreman", "engineer", "miller", "molder", "panel beater", "patternmaker", "plumber", "sawfiler", "foreman", "soaper", "wheelwright", "woodworkers"];
        return randomName(adjectives) + ' ' + randomName(nouns);
    }
    /**
     * Random Name Picker
     */
    function randomName(list) {
        var i = Math.floor(Math.random() * list.length);
        return list[i];
    }
    /**
     * UUID generator
     */
    function generateUUID() {
        var d = new Date().getTime();
        var uuid = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
            var r = (d + Math.random()*16)%16 | 0;
            d = Math.floor(d/16);
            return (c=='x' ? r : (r&0x3|0x8)).toString(16);
        });
        return uuid;
    }
    // Set Cookie
    function setCookie(cname, cvalue, exdays, path) {
        var d = new Date();
        if (path){
            var path = path;
        } else {
            var path = "";
        }
        d.setTime(d.getTime() + (exdays*24*60*60*1000));
        var expires = "expires="+d.toUTCString();
        document.cookie = cname + "=" + cvalue + "; " + expires + "; path=/" + path;
    }
    // Get Cookie
    function getCookie(cname) {
        var name = cname + "=";
        var ca = document.cookie.split(';');
        for (var i = 0; i < ca.length; i++) {
            var c = ca[i];
            while (c.charAt(0) == ' ') {
                c = c.substring(1);
            }
            if (c.indexOf(name) == 0) {
                return c.substring(name.length, c.length);
            }
        }
        return "";
    }
    /**
     * Global Variables
     */
    var SAVE_KEY = 'game_save';
    var state = load();
    if (state && state.monsters && state.inventory) {
        state = state;
    } else {
        var state = {
            player: {
                lvl: 1,
                xp: 0,
                units: 10,
                health: 100,
                maxHealth: 100,
                potionCount: 25,
                weaponParts: 0,
                weapon: {
                    id: '001',
                    name: 'sword',
                    dmg: 25,
                    el: 'none',
                    crit: 25 * 2,
                    crit_p: 0,
                    special: 25 + (25 / 2),
                    imgURL: 'img/Sword1.png',
                    rare: 'basic'
                }
            },
            inventory:[{
                id: '001',
                name: 'sword',
                dmg: 25,
                el: 'none',
                crit: 25 * 2,
                crit_p: 0,
                special: 25 + (25 / 2),
                imgURL: 'img/Sword1.png',
                rare: 'basic'
            }],
            level: 'stage1',
            killCount: 0
        };
        state.monsters = buildMonsters(state.player);
        save(state);
    }
    if (state.shop) {
        var shopRefresh = getCookie('shopRefresh');
        if (shopRefresh != "") {
            // don't refresh the shop
            state.shop = state.shop;
        } else {
            // Refresh the shop
            state.shop = buildShop(state);
            setCookie('shopRefresh', 'value', 3, '');
        }
    } else {
        state.shop = buildShop(state);
    }
    /**
     * Initial Load / Save
     */
    renderCharacter(state.player);
    renderLevel(state);
    if(state.boss) {
        renderBoss(state.boss);
    } else {
        renderMonsters(state.monsters);
    }
    renderInventory(state.inventory);
    updatePlayer(state.player);
    renderShop();
    /**
     * Save state
     * @param state
     */
    function save(state) {
        localStorage.setItem(SAVE_KEY, JSON.stringify(state));
    }
    /**
     * Load state
     */
    function load() {
        return JSON.parse(localStorage.getItem(SAVE_KEY));
    }
    /**
     * Game Reset
     */
    function gameReset() {
        var resetConfirm = confirm("This will wipe your character and start fresh. Only use this if you get stuck or if there is an update that requires it.");
        if (resetConfirm == true) {
            var state = '';
            save(state);
            window.location.reload(true);
        }
    }
    /**
     * Game Reset
     * usage: notif.ok('OK!');
     * usage: notif.err('Error!');
     */
    var notif = {
        ok: function(message){
            var holder = $('#notif');
            var notification = '<div class="message ok">'+ message +'</div>';
            displayNotification(notification);
        },
        err: function(message){
            var holder = $('#notif');
            var notification = '<div class="message err">'+ message +'</div>';
            displayNotification(notification);
        }
    };
    function displayNotification(message) {
        var holder = $('#notif');
        holder.append(message);
        //holder.addClass('active');
        holder.animate({ height: holder[0].scrollHeight}, 300);
        setTimeout(function(){
            //holder.removeClass('active');
            holder.animate({ height: 0}, 300);
            setTimeout(function(){
                holder.empty();
            }, 100);
        }, 3000);
    }
    /**
     * Coin Toss
     * returns true or false
     */
    function coinToss() {
        return Math.random() > 0.5;
    }
    function rollDice(n){
        var number = n?n:1;
        var x = Math.floor(Math.random() * ((6-1)+1) + 1);
        var y = Math.floor(Math.random() * ((6-1)+1) + 1);
        var z = Math.floor(Math.random() * ((6-1)+1) + 1);
        if(number === 3) {
            var total = x + y + z;
        } else if(number === 2) {
            total = x + y;
        } else {
            total = x;
        }
        return total;
    }
    /**
     * Attack
     */
    function attack(player, monster){
        var playerHealth = player.health;
        var playerDMG = player.weapon.dmg;
        var playerCrit = player.weapon.crit;
        var playerCritPercent = player.weapon.crit_p?player.weapon.crit_p/100:0.25;
        var critChance = Math.random();
        var weaponEl = player.weapon.el;
        var monsterShield = monster.shield;
        var monsterHealth = monster.health;
        var monsterDMG = monster.dmg;
        var monsterEl = monster.el;
        var critRollPlayer = rollDice(2);
        var critRollMonster = rollDice(2);
        var playerMiss = rollDice(3);
        var monsterMiss = rollDice(3);
        /**
         * Miss Chance
         */
        if(playerMiss === 3) {
            playerDMG = 0;
        }
        if(monsterMiss === 3) {
            monsterDMG = 0;
        }
        /**
         *  same element damage 90%
         *  water > fire
         *  fire > earth
         *  earth > water
         */
        if(weaponEl === monsterEl) {
            playerDMG = playerDMG * 1;
        } else if(weaponEl === 'water' && monsterEl === 'fire') {
            playerDMG = playerDMG * 1.5;
        } else if(weaponEl === 'water' && monsterEl === 'earth') {
            playerDMG = playerDMG * 0.75;
        } else if(weaponEl === 'fire' && monsterEl === 'earth') {
            playerDMG = playerDMG * 1.5;
        } else if(weaponEl === 'fire' && monsterEl === 'water') {
            playerDMG = playerDMG * 0.75;
        } else if(weaponEl === 'earth' && monsterEl === 'water') {
            playerDMG = playerDMG * 1.5;
        } else if(weaponEl === 'earth' && monsterEl === 'fire') {
            playerDMG = playerDMG * 0.75;
        }
        /**
         * Weapon Critical hit chance
         */
        if (critChance < playerCritPercent) {
            criticalHitMonster(monster);
            if(monster.shield > 0){
                monster.shield = monsterShield - playerCrit;
            } else {
                monster.health = monsterHealth - playerCrit;
            }
        } else {
            if(monster.shield > 0){
                monster.shield = monsterShield - playerDMG;
            } else {
                monster.health = monsterHealth - playerDMG;
            }
        }
        if (monster.health < 1) {
            grantXP(player, 125);
            grantUnits(player, 10);
            destroyMonster(monster);
            var monsterCount = $('#battleground').find('.monster').length;
            if(monsterCount <= 0) {
                levelComplete();
            }
        } else {
            updateMonster(monster);
            if(critRollMonster === 7){
                criticalHitPlayer();
                player.health = playerHealth - monster.crit;
            } else {
                player.health = playerHealth - monsterDMG;
            }
        }
        if (player.health < 1) {
            destroyPlayer(player);
        } else {
            updatePlayer(player);
        }
    }
    /**
     * Critical Hit Player
     */
    function criticalHitPlayer() {
        var healthbar = $('#character .healthbar');
        healthbar.addClass('animated headShake');
        healthbar.find('.inner-health').addClass('animated headShake');
        setTimeout(function(){
            healthbar.removeClass('animated headShake');
            healthbar.find('.inner-health').removeClass('animated headShake');
        }, 1000);
    }
    /**
     * Critical Hit Monster
     */
    function criticalHitMonster(monster) {
        var shield = $('.monster[data-monster="'+ monster.name +'"]').find('.shield');
        var healthbar = $('.monster[data-monster="'+ monster.name +'"]').find('.healthbar');
        if(monster.shield > 0){
            shield.addClass('animated headShake');
            shield.find('.inner-shield').addClass('animated headShake');
            setTimeout(function(){
                shield.removeClass('animated headShake');
                shield.find('.inner-shield').removeClass('animated headShake');
            }, 1000);
        } else {
            healthbar.addClass('animated headShake');
            healthbar.find('.inner-health').addClass('animated headShake');
            setTimeout(function(){
                healthbar.removeClass('animated headShake');
                healthbar.find('.inner-health').removeClass('animated headShake');
            }, 1000);
        }
    }
    /**
     * Get Monster
     * @param monsterID
     */
    function getMonster(monsterID){
        if(state.boss){
            if(state.boss.name === monsterID){
                return state.boss;
            }
        } else {
            for(i=0;i<state.monsters.length;i++){
                if(state.monsters[i].name === monsterID){
                    return state.monsters[i];
                }
            }
        }
    }
    /**
     * Update Monster
     * @param monster
     */
    function updateMonster(monster){
        console.log('updateMonster(monster)');
        // Update Shield
        var shield = $('.monster[data-monster="'+ monster.name +'"]').find('.shield');
        shield.find('.shield-digit > span').html(monster.shield);
        shield.find('.inner-shield').width(monster.shield + '%');
        // Update Healthbar
        var healthbar = $('.monster[data-monster="'+ monster.name +'"]').find('.healthbar');
        healthbar.find('.health-digit > span').html(monster.health);
        var newHealth = Math.floor( (monster.health / monster.maxHealth) * 100);
        healthbar.find('.inner-health').width(newHealth + '%');
    }
    /**
     * Destroy Monster
     * @param monster
     */
    function destroyMonster(monster){
        console.log('destroyMonster(monster)');
        $('.monster[data-monster="'+ monster.name +'"]').remove();
        state.killCount = state.killCount+1;
        var multiple_potions = coinToss();
        var potion_number = randomIntFromInterval(3,4);
        if(multiple_potions) {
            grantPotions(state.player, potion_number);
        } else {
            grantPotions(state.player, 2);
        }
        if(monster.boss){
            notif.ok('You found a new weapon! Check your inventory.');
            grantWeapon(true);
            grantPotions(state.player, 10);
            // update level background
            updateBG();
        }
        updatePlayer(state.player);
    }
    /**
     * Update Player
     * @param player
     */
    function updatePlayer(player){
        console.log('updatePlayer(player)');
        // Update Header Info
        var lvl = $('#header #level > span');
        var xp = $('#header #xp > span');
        var units = $('#header #units > span');
        var wparts = $('#header #wparts > span');
        lvl.html(player.lvl);
        xp.html(player.xp);
        units.html(player.units);
        wparts.html(player.weaponParts);
        // Update Healthbar
        var healthbar = $('#character .healthbar');
        healthbar.find('.health-digit > span').html(player.health);
        var newHealth = Math.floor( (player.health / player.maxHealth) * 100);
        healthbar.find('.inner-health').width(newHealth + '%');
        // Update PotionCount
        var potions = $('#character #potion');
        potions.find('span.potion-count').html(player.potionCount);
        //save
        save(state);
    }
    /**
     * Grant XP
     * @param int
     */
    function grantXP(player, xp){
        console.log('grantXP(player, int)');
        player.xp = player.xp + xp;
        if (player.xp >= 1000) {
            var lvlInc = Math.floor(player.xp / 1000);
            player.lvl = player.lvl + lvlInc;
            player.xp = player.xp - (lvlInc * 1000);
        }
    }
    /**
     * Grant Units
     * @param int
     */
    function grantUnits(player, units){
        console.log('grantUnits(player, int)');
        player.units = player.units + units;
    }
    /**
     * Grant Weapon Parts
     * @param int
     */
    function grantWeaponParts(player, wparts){
        console.log('grantWeaponParts(player, int)');
        player.weaponParts = player.weaponParts + wparts;
    }
    /**
     * Grant Weapon
     * @param upgrade
     */
    function grantWeapon(upgrade) {
        if(upgrade === true){
            var weapon = generateWeapon(state.player, true);
        } else {
            var weapon = generateWeapon(state.player);
        }
        if(state.inventory.length > 60) {
            notif.err('You have too many items. please remove some before completing the next level.');
        } else {
            state.inventory.push(weapon);
        }
        renderInventory(state.inventory);
    }
    /**
     * Upgrade Weapon
     * @param upgrade
     */
    function upgradeWeapon(weapon, dmg, crit) {
        var holder = $('#upgrade-modal');
        var inventory = state.inventory;
        if(state.player.weaponParts < 10) {
            notif.err('You have insufficient parts to upgrade.');
        } else {
            for (i = 0; i < inventory.length; i++) {
                var itemIndex = inventory.indexOf(inventory[i]);
                if (inventory[i].id === weapon.id) {
                    if (dmg && dmg > 0) {
                        inventory[i].dmg = inventory[i].dmg + dmg;
                        state.player.weaponParts = state.player.weaponParts - 10;
                        holder.find('.stats span.dmg > span').html(inventory[i].dmg);
                        holder.find('.weapon-parts > span').html(state.player.weaponParts);
                    }
                    if (crit && crit > 0) {
                        inventory[i].crit = inventory[i].crit + crit;
                        state.player.weaponParts = state.player.weaponParts - 10;
                        holder.find('.stats span.crit > span').html(inventory[i].crit);
                        holder.find('.weapon-parts > span').html(state.player.weaponParts);
                    }
                    if (state.player.weapon.id === weapon.id) {
                        state.player.weapon = inventory[i];
                    }
                }
            }
            updatePlayer(state.player);
            save(state);
        }
    }
    /**
     * Grant potions
     * @param int
     */
    function grantPotions(player, int){
        console.log('grantPotions(int)');
        if (player.potionCount < 999) {
            player.potionCount = player.potionCount + int;
        }
    }
    /**
     * Destroy Player
     * @param player
     */
    function destroyPlayer(player){
        console.log('destroyPlayer(player)');
        notif.err('You Died! üò¢');
        //gameReset();
        //var player_lvl = (player.lvl>2)?(player.lvl-1):1;
        //state.player.lvl = player_lvl;
        state.player.xp = 0;
        state.player.health = state.player.maxHealth;
        state.level = 'stage1';
        state.boss = null;
        state.killCount = 0;
        state.monsters = buildMonsters(state.player);
        if(state.player.potionCount < 5){
            grantPotions(state.player, 15);
        }
        renderMonsters(state.monsters);
        updatePlayer(state.player);
        save(state);
    }
    /**
     * Update Player Weapon
     * @param player
     */
    function updatePlayerWeapon(player){
        console.log('updatePlayerWeapon(player)');
        var weaponHolder = $('#character #weapon .weapon-holder');
        weaponHolder.empty();
        weaponHolder.attr('data-rare', player.weapon.rare);
        weaponHolder.html('<img class="weapon-element" src="img/'+ player.weapon.el +'.png"><img src="'+ player.weapon.imgURL +'">');
        // Close Inventory
        var inventory = $('#inventory');
        if(inventory.hasClass('active')){
            inventory.removeClass('active');
        } else {
            inventory.addClass('active');
        }
        save(state);
    }
    /**
     * Delete Inventory Item
     * @param itemID
     */
    function deleteInventoryItem(itemID){
        console.log('deleteInventoryItem(inventory)');
        var inventory = state.inventory;
        for(i=0;i<inventory.length; i++){
            var itemIndex = inventory.indexOf(inventory[i]);
            if(inventory[i].id === itemID){
                if(state.player.weapon.id === itemID) {
                    notif.err('You cannot delete an equipped weapon.');
                } else {
                    inventory.splice(itemIndex, 1);
                }
            }
        }
        //grant weapon parts
        grantWeaponParts(state.player, randomIntFromInterval(5,10));
        updatePlayer(state.player);
        renderInventory(inventory);
        save(state);
    }
    /**
     * Level Complete
     * @param monsterID
     */
    function levelComplete(){
        notif.ok('Level Complete!');
        if (state.killCount >= 25) {
            state.monsters = [];
            state.boss = buildBoss(state.player);
            renderBoss(state.boss);
            state.killCount = 0;
        } else {
            state.boss = null;
            state.monsters = buildMonsters(state.player);
            renderMonsters(state.monsters);
        }
        state.player.maxHealth = state.player.maxHealth + 15;
        state.player.health = state.player.maxHealth;
        updatePlayer(state.player);
        var weaponGrant = coinToss();
        if(weaponGrant) {
            notif.ok('You found a new weapon! Check your inventory.');
            //generate weapon
            grantWeapon();
        }
        //give units
        grantUnits(player, 25);
        //save
        save(state);
    }
    /**
     * Background Update
     * @param
     */
    function updateBG(){
        if(!state.lvlBG) {
            state.lvlBG = 'img/bg1.jpg';
        }
        state.lvlBG = randomBGimg();
        var battleground = document.getElementById('battleground');
        if(battleground) {
            battleground.style.backgroundImage = 'url(' + state.lvlBG + ')';
        }
        //save
        save(state);
    }
    /**
     * Render Level
     * @param state
     */
    function renderLevel(state){
        console.log('renderLevel()');
        if(!state.lvlBG) {
            state.lvlBG = 'img/bg1.jpg';
        }
        var battleground = document.getElementById('battleground');
        if(battleground) {
            battleground.style.backgroundImage = 'url(' + state.lvlBG + ')';
        }
    }
    /**
     * Render Character
     * @param player
     */
    function renderCharacter(player){
        console.log('renderCharacter()');
        var character = $('#character');
        var frag = [];
        if(character) {
            character.empty();
            frag.push('' +
                '<div class="character-left clearfix">' +
                '   <div id="player"><i class="icon-space-hunter"></i></div>' +
                '   <div id="health">' +
                '       <div class="healthbar">' +
                '           <span class="health-digit"><span>100</span> ‚ù§Ô∏è</span>' +
                '           <div class="inner-health"></div>' +
                '       </div>' +
                '   </div>' +
                '</div>' +
                '<div class="character-right clearfix">' +
                '   <div id="potion" class="player-potion">' +
                '   <span class="inner"><i class="icon-potion-bubbles"></i> <span class="potion-count">'+ player.potionCount +'</span></span>' +
                '</div>' +
                '<div id="weapon" class="player-attack">' +
                '   <span class="weapon-holder inner" data-rare="'+ player.weapon.rare +'">' +
                '       <img class="weapon-element" src="img/'+ player.weapon.el +'.png">' +
                '       <img src="'+ player.weapon.imgURL +'">' +
                '   </span>' +
                '</div>');
            character.append(frag.join(''));
        }
    }
    /**
     * Build Monsters
     * @param monsters
     */
    function buildMonsters(player){
        console.log('buildMonsters()');
        var monsters = [];
        var monster_number = randomIntFromInterval(4,10);
        for(i=0;i<monster_number;i++){
            var monster_lvl = player.lvl - 1 + randomIntFromInterval(1,3);
            var healthCalc = player.lvl * 35;
            var monster_health = randomIntFromInterval((healthCalc / 1.5),healthCalc);
            if (monster_health < 100) {
                monster_health = 100;
            }
            var monster_dmg = randomIntFromInterval(player.maxHealth / 10,player.maxHealth / 6);
            var monster_crit = randomIntFromInterval(monster_dmg * 1.25,monster_dmg * 1.75);
            var monster_shield = 10*Math.floor(Math.random()*11);
            var sprite_x = 64*Math.floor(Math.random()*16);
            var sprite_y = 64*Math.floor(Math.random()*16);
            var monster = {
                lvl: monster_lvl,
                el: randomElemental(),
                dmg: monster_dmg,
                crit: monster_crit,
                shield: monster_shield,
                health: monster_health,
                maxHealth: monster_health,
                name: randomMonsterName(),
                id: monster_number[i],
                imgX: sprite_x,
                imgY: sprite_y
            };
            monsters.push(monster);
        }
        return monsters;
    }
    /**
     * Render the monsters in the battlefield
     * @param monsters
     */
    function renderMonsters(monsters){
        console.log('renderMonsters()');
        // Render Monsters
        var battleground = $('#battleground');
        var frag = [];
        if(battleground) {
            battleground.empty();
            //for (var i = monsters.length - 1; i >= 0; --i) {
            for (i=0;i < monsters.length; i++) {
                //console.log(monsters[i]);
                if(monsters[i].health > 0) {
                    frag.push('' +
                        '<div class="monster" data-monster="' + monsters[i].name + '" data-element="' + monsters[i].el + '">' +
                        '   <div class="monster-img" style="background-position:-' + monsters[i].imgX + 'px -' + monsters[i].imgY + 'px;"></div>' +
                        '   <div class="monster-name">' +
                        '       <span class="name">' + monsters[i].name + '</span>' +
                        '   </div>' +
                        '   <button class="attack-monster"></button>' +
                        '   <div class="monster-details">' +
                        '       <div class="stats clearfix">' +
                        '           <span class="level">' + monsters[i].lvl + '</span>' +
                        '           <span class="elemental" style="background-image:url(img/' + monsters[i].el + '.png);"><span>' + monsters[i].el + '</span>Ô∏è</span>' +
                        '           <span class="dmg"><span>' + monsters[i].dmg + '</span>Ô∏è</span>' +
                        //'           <span class="shield">shield: <span>' + monsters[i].shield + '</span>Ô∏è</span>' +
                        '       </div>' +
                        '   </div>' +
                        '   <div class="shield">' +
                        '       <span class="shield-digit"><span>' + monsters[i].shield + '</span></span>' +
                        '       <div class="inner-shield" style="width:' + monsters[i].shield + '%"></div>' +
                        '   </div>' +
                        '   <div class="healthbar">' +
                        '       <span class="health-digit"><span>' + monsters[i].maxHealth + '</span>Ô∏è</span>' +
                        '       <div class="inner-health"></div>' +
                        '   </div>' +
                        '</div>');
                }
            }
            battleground.append(frag.join(''));
            for (i=0;i < monsters.length; i++) {
                updateMonster(monsters[i]);
            }
            battleground.animate({ scrollTop: battleground[0].scrollHeight}, 1000);
        }
    }
    /**
     * Build Boss
     * @param player
     */
    function buildBoss(player){
        console.log('buildBoss()');
        var boss_number = 1;
        var boss_lvl = player.lvl;
        var healthCalc = player.lvl * 90;
        var boss_health = randomIntFromInterval((healthCalc / 1.5),healthCalc);
        if (boss_health < 200) {
            boss_health = 200;
        }
        var boss_dmg = randomIntFromInterval(player.maxHealth / 6,player.maxHealth / 4);
        var boss_crit = randomIntFromInterval(boss_dmg * 1.25,boss_dmg * 1.75);
        var boss_shield = 10*Math.floor(Math.random()*22);
        var sprite_x = 64*Math.floor(Math.random()*16);
        var sprite_y = 64*Math.floor(Math.random()*16);
        var boss = {
            lvl: boss_lvl,
            boss: boss_lvl,
            el: randomElemental(),
            dmg: boss_dmg,
            crit: boss_crit,
            shield: boss_shield,
            health: boss_health,
            maxHealth: boss_health,
            name: randomMonsterName(),
            id: boss_number,
            imgX: sprite_x,
            imgY: sprite_y
        };
        return boss;
    }
    /**
     * Render the boss in the battlefield
     * @param boss
     */
    function renderBoss(boss){
        console.log('renderBoss()');
        var battleground = $('#battleground');
        var frag = [];
        if(battleground) {
            battleground.empty();
            frag.push('' +
                '<div class="monster boss" data-boss="' + boss.name + '" data-monster="' + boss.name + '" data-element="' + boss.el + '">' +
                '   <div class="monster-img" style="background-position:-' + boss.imgX + 'px -' + boss.imgY + 'px;"></div>' +
                '   <div class="monster-name">' +
                '       <span class="name">Boss: ' + boss.name + '</span>' +
                '   </div>' +
                '   <button class="attack-monster"></button>' +
                '   <div class="monster-details">' +
                '       <div class="stats clearfix">' +
                '           <span class="level">' + boss.lvl + '</span>' +
                '           <span class="elemental" style="background-image:url(img/' + boss.el + '.png);"><span>' + boss.el + '</span>Ô∏è</span>' +
                '           <span class="dmg"><span>' + boss.dmg + '</span>Ô∏è</span>' +
                //'           <span class="shield">shield: <span>' + boss.shield + '</span>Ô∏è</span>' +
                '       </div>' +
                '   </div>' +
                '   <div class="shield">' +
                '       <span class="shield-digit"><span>' + boss.shield + '</span></span>' +
                '       <div class="inner-shield" style="width:' + boss.shield + '%"></div>' +
                '   </div>' +
                '   <div class="healthbar">' +
                '       <span class="health-digit"><span>' + boss.maxHealth + '</span>Ô∏è</span>' +
                '       <div class="inner-health"></div>' +
                '   </div>' +
                '</div>');
            battleground.append(frag.join(''));
            battleground.animate({ scrollTop: battleground[0].scrollHeight}, 1000);
        }
    }
    /**
     * Render the inventory with items owned
     * @param inventory
     */
    function renderInventory(inventory){
        console.log('renderInventory()');
        // Update Healthbar
        var holder = $('#inventory');
        var frag = [];
        if(holder) {
            holder.empty();
            frag.push('<span class="toggle-inventory">x</span>');
            frag.push('<div id="item-viewer" class="clearfix"></div>');
            frag.push('<div class="inventory-grid clearfix">');
            for (i=0;i < inventory.length; i++) {
                frag.push('' +
                    '<div class="item" data-item="' + inventory[i].name + '" data-item-id="' + inventory[i].id + '" data-rare="' + inventory[i].rare + '">' +
                    //'   <img class="elemental" src="img/' + inventory[i].el + '.png">' +
                    '   <div class="item-img" style="background-image:url(' + inventory[i].imgURL + ');"></div>' +
                    '</div>');
            }
            frag.push('</div>');
            holder.append(frag.join(''));
            renderWeaponViewer();
        }
    }
    /**
     * Render the inventory Viewer
     * @param item
     */
    function renderWeaponViewer(weapon){
        console.log('renderWeaponViewer()');
        var holder = $('#item-viewer');
        var frag = [];
        if(!weapon || weapon == '') {
            var weapon = state.player.weapon;
        }
        if(holder) {
            holder.empty();
            holder.attr('data-rare', weapon.rare);
            holder.css('background-image', 'url(' + weapon.imgURL + ')');
            frag.push('' +
                '<div class="stats clearfix">' +
                '   <span class="element">elm: <img src="img/' + state.player.weapon.el + '.png"></span>' +
                '   <span class="dmg">dmg: ' + state.player.weapon.dmg + '</span>' +
                '   <span class="crit">crit: ' + state.player.weapon.crit + '</span>' +
                '   <span class="crit_p">crit %: ' + state.player.weapon.crit_p + '</span>' +
                '   <span class="special">sp: ' + state.player.weapon.special + '</span>' +
                '   <div class="equipped  clearfix">' +
                '       <span class="element">elm: <img src="img/' + weapon.el + '.png"></span>' +
                '       <span class="dmg">dmg: ' + weapon.dmg + '</span>' +
                '       <span class="crit">crit: ' + weapon.crit + '</span>' +
                '       <span class="crit_p">crit %: ' + weapon.crit_p + '</span>' +
                '       <span class="special">sp: ' + weapon.special + '</span>' +
                '   </div>' +
                '</div>' +
                '<div class="actions clearfix">' +
                '   <button class="equip" data-item-id="'+ weapon.id +'">Equip</button>' +
                '   <button class="upgrade" data-item-id="'+ weapon.id +'" data-button="blue">Upgrade</button>' +
                '   <button class="delete" data-item-id="'+ weapon.id +'" data-button="red"><i class="icon-trash-a"></i></button>' +
                '</div>');
            holder.append(frag.join(''));

            $('.inventory-grid .item').removeClass('active');
            var selectedItem = $('.inventory-grid .item[data-item-id="'+ weapon.id +'"]');
            if(!selectedItem.hasClass('active')){
                selectedItem.addClass('active');
            }
        }
    }
    /**
     * Render Upgrade Modal
     * @param weapon
     */
    function renderUpgradeModal(weapon){
        console.log('renderUpgradeModal()');
        var holder = $('#upgrade-modal');
        var frag = [];
        if(!weapon || weapon == '') {
            var weapon = state.player.weapon;
        }
        if(holder) {
            holder.empty();
            //holder.attr('data-rare', weapon.rare);
            //holder.css('background-image', 'url(' + weapon.imgURL + ')');
            frag.push('<span class="toggle-upgrade-modal">x</span>');
            frag.push('' +
                '<div class="item-viewer" data-rare="' + weapon.rare + '" style="background-image:url(' + weapon.imgURL + ');">' +
                '<span class="weapon-parts"><i class="icon-weapon-parts"></i><span>'+ state.player.weaponParts +'</span></span>' +
                '<div class="stats clearfix">' +
                //'   <span class="element">elm: <img src="img/' + state.player.weapon.el + '.png"></span>' +
                //'   <span class="dmg">dmg: ' + state.player.weapon.dmg + '</span>' +
                //'   <span class="crit">crit: ' + state.player.weapon.crit + '</span>' +
                //'   <span class="crit_p">crit %: ' + state.player.weapon.crit_p + '</span>' +
                //'   <span class="special">sp: ' + state.player.weapon.special + '</span>' +
                '   <div class="equipped  clearfix">' +
                '       <span class="element">elm: <img src="img/' + weapon.el + '.png"></span>' +
                '       <span class="dmg">dmg: <span>' + weapon.dmg + '</span></span>' +
                '       <span class="crit">crit: <span>' + weapon.crit + '</span></span>' +
                '       <span class="crit_p">crit %: ' + weapon.crit_p + '</span>' +
                '       <span class="special">sp: <span>' + weapon.special + '</span></span>' +
                '   </div>' +
                '</div>' +
                '<div class="actions clearfix">' +
                '   <button class="upgrade-damage" data-item-id="'+ weapon.id +'">+ DMG (<i class="icon-weapon-parts"></i>10)</button>' +
                '   <button class="upgrade-crit" data-item-id="'+ weapon.id +'">+ CRIT (<i class="icon-weapon-parts"></i>10)</button>' +
                '</div>' +
                '</div>');
            holder.append(frag.join(''));
        }
    }
    /**
     * Build Shop
     * @param player
     */
    function buildShop(state){
        console.log('buildShop()');
        var shopInventory = {};
        var potions = [
            {
                name: 'Small Health',
                type: 'healing',
                size: 'small',
                amount: 25,
                price: 100
            }
            /*{
                name: 'Medium Health',
                type: 'healing',
                size: 'medium',
                amount: 50,
                price: 200
            },
            {
                name: 'Large Health',
                type: 'healing',
                size: 'large',
                amount: 100,
                price: 300
            }*/
        ];
        var weapons = [
            generateWeapon(state.player, false, 100),
            generateWeapon(state.player, true, 200),
            generateWeapon(state.player, false, 125)
        ];

        shopInventory.potions = potions;
        shopInventory.weapons = weapons;
        return shopInventory;
    }
    /**
     * Render the shop
     * @param
     */
    function renderShop(){
        console.log('renderShop()');
        var holder = $('#shop');
        var frag = [];
        if(holder) {
            holder.empty();
            frag.push('<span class="toggle-shop">x</span>');
            frag.push('<div id="shop-potions" class="clearfix"></div>');
            frag.push('<div id="shop-weapons" class="clearfix"></div>');
        }
        holder.append(frag.join(''));
        renderShopPotions();
        renderShopWeapons();
    }
    /**
     * Render shop potions
     * @param null
     */
    function renderShopPotions(){
        console.log('renderShopPotions()');
        var holder = $('#shop-potions');
        var potionVal = Math.floor(state.player.maxHealth / 4.33);
        var frag = [];
        if(holder) {
            holder.empty();
            frag.push('<div class="item-grid potion-grid">');
            for (i=0;i < state.shop.potions.length; i++) {
                frag.push('' +
                    '<div class="shop-item">' +
                    '   <span class="price">$' + state.shop.potions[i].price + '</span>' +
                    '   <div class="item" data-item="' + state.shop.potions[i].name + '" data-size="' + state.shop.potions[i].size + '">' +
                    '       <i class="icon-potion"></i>' +
                    '   </div>' +
                    //'   <span class="amount">+'+ potionVal +'</span>' +
                    '   <button class="purchase" data-item-id="' + i + '" data-type="potion">Buy</button>' +
                    '</div>');
            }
            frag.push('</div>');
            frag.push('</div>');
            holder.append(frag.join(''));
        }
    }
    /**
     * Render shop weapons
     * @param player
     */
    function renderShopWeapons(){
        console.log('renderShopWeapons()');
        var holder = $('#shop-weapons');
        var frag = [];
        if(holder) {
            holder.empty();
            frag.push('<div class="item-grid weapon-grid">');
            for (i=0;i < state.shop.weapons.length; i++) {
                frag.push('' +
                    '<div class="shop-item" data-price="' + state.shop.weapons[i].price + '">' +
                    '   <span class="price">$' + state.shop.weapons[i].price + '</span>' +
                    '   <div class="item" data-item="' + state.shop.weapons[i].name + '" data-item-id="' + state.shop.weapons[i].id + '" data-rare="' + state.shop.weapons[i].rare + '">' +
                    '       <div class="item-img" style="background-image:url(' + state.shop.weapons[i].imgURL + ');"></div>' +
                    '   </div>' +
                    '   <div class="stats clearfix">' +
                    '       <span class="element"><img src="img/' + state.shop.weapons[i].el + '.png"></span>' +
                    '       <span class="dmg">' + state.shop.weapons[i].dmg + '</span>' +
                    '       <span class="crit">' + state.shop.weapons[i].crit + '</span>' +
                    '       <span class="crit_p">' + state.shop.weapons[i].crit_p + '</span>' +
                    '       <span class="special">' + state.shop.weapons[i].special + '</span>' +
                    '   </div>' +
                    '   <button class="purchase" data-item-id="' + i + '" data-type="weapon">Buy</button>' +
                    '</div>');
            }
            if (state.shop.weapons.length < 1) {
                frag.push('<p class="noitems">No more weapons for sale. <br>Check back in a couple days!</p>');
            }
            frag.push('</div>');
            frag.push('</div>');
            holder.append(frag.join(''));
        }
    }
    /**
     * Purchase Shop Item
     * @param price
     */
    function purchaseItem(item, type){
        console.log('purchaseItem(price)');
        var playerUnits = state.player.units;
        if(playerUnits < item.price) {
            notif.err('You have insufficient credits for this purchase.');
        } else {
            if (type === 'weapon') {
                if(state.inventory.length > 60) {
                    notif.err('You have too many items. please remove some before purchasing.');
                } else {
                    state.inventory.push(item);
                    state.shop.weapons.splice($.inArray(item, state.shop.weapons),1);
                    renderShopWeapons();
                }
            } else if (type === 'potion') {
                if (state.player.potionCount < 999) {
                    state.player.potionCount = state.player.potionCount + 1;
                } else {
                    notif.err('You have the maximum allowed potions.');
                }
            }
            state.player.units = state.player.units - item.price;
        }
        renderInventory(state.inventory);
        updatePlayer(state.player);
        save(state);
    }
    /**
     * Generate Weapon
     * @param player
     */
    function generateWeapon(player, upgrade, price){
        console.log('generateWeapon()');
        //var weapon_number = state.inventory.length + 1;
        //var weaponID = 'w' + weapon_number.toString();
        var weaponID = generateUUID();
        var weapon_dmg = randomIntFromInterval(player.lvl*2+40,player.lvl*2.3+50);
        if(upgrade === true){
            var highestDMG = getHighWeapon();
            weapon_dmg = randomIntFromInterval(highestDMG + 1,highestDMG + 10);
            //console.log(highestDMG);
            //console.log(weapon_dmg);
        }
        var rarity = randomRarity();
        var weapon_crit = randomIntFromInterval(weapon_dmg * 1.25,weapon_dmg * 1.75);
        var crit_percent = randomIntFromInterval(1,15);
        if (rarity === 'rare') {
            var crit_percent = randomIntFromInterval(15,33);
        } else if (rarity === 'legendary') {
            var crit_percent = randomIntFromInterval(33,50);
        } else if (rarity === 'exotic') {
            var crit_percent = randomIntFromInterval(50,99);
        }
        var weapon_el = randomElemental();
        var weapon_img = 'img/pistol_'+ randomIntFromInterval(1,40) +'.png';
        if(weapon_el === 'water'){
            weapon_img = 'img/pistol_'+ randomIntFromInterval(1,10) +'.png';
        } else if(weapon_el === 'fire'){
            weapon_img = 'img/pistol_'+ randomIntFromInterval(11,20) +'.png';
        } else if(weapon_el === 'earth'){
            weapon_img = 'img/pistol_'+ randomIntFromInterval(21,30) +'.png';
        }
        if(price){
            weapon_value = price;
        } else {
            var highestDMG = getHighWeapon();
            weapon_value = randomIntFromInterval(highestDMG * 10,highestDMG * 15);
        }
        var weapon = {
            id: weaponID,
            name: randomMonsterName(),
            dmg: weapon_dmg,
            el: weapon_el,
            crit: weapon_crit,
            crit_p: crit_percent,
            special: weapon_dmg + weapon_crit,
            imgURL: weapon_img,
            rare: rarity,
            price: weapon_value
        };
        return weapon;
    }
    /**
     * Get Weapon
     * @param itemID
     */
    function getHighWeapon(){
        var damages = [];
        for(i=0;i<state.inventory.length;i++){
            damages.push(state.inventory[i].dmg)
        }
        return Math.max.apply(null, damages);
    }
    /**
     * Get Highest Weapon Damage from inventory
     * @param itemID
     */
    function getWeapon(weaponID){
        for(i=0;i<state.inventory.length;i++){
            if(state.inventory[i].id === weaponID){
                return state.inventory[i];
            }
        }
    }
    /**
     * Toggle Inventory
     */
    function toggleInventory(visibility){
        var inventory = $('#inventory');
        if (visibility === 'show') {
            if(!inventory.hasClass('active')){
                inventory.addClass('active');
                toggleShop('hide');
                toggleSettings('hide');
            }
        } else if (visibility === 'hide') {
            if(inventory.hasClass('active')){
                inventory.removeClass('active');
            }
        } else {
            if(inventory.hasClass('active')){
                inventory.removeClass('active');
            } else {
                inventory.addClass('active');
                toggleShop('hide');
                toggleSettings('hide');
            }
        }
    }
    /**
     * Toggle Shop
     */
    function toggleShop(visibility){
        var shop = $('#shop');
        if (visibility === 'show') {
            if(!shop.hasClass('active')){
                shop.addClass('active');
                toggleInventory('hide');
                toggleSettings('hide');
            }
        } else if (visibility === 'hide') {
            if(shop.hasClass('active')){
                shop.removeClass('active');
            }
        } else {
            if(shop.hasClass('active')){
                shop.removeClass('active');
            } else {
                shop.addClass('active');
                toggleInventory('hide');
                toggleSettings('hide');
            }
        }
    }
    /**
     * Toggle Settings
     */
    function toggleSettings(visibility){
        var settings = $('#settings');
        if (visibility === 'show') {
            if(!settings.hasClass('active')){
                settings.addClass('active');
                toggleInventory('hide');
                toggleShop('hide');
            }
        } else if (visibility === 'hide') {
            if(settings.hasClass('active')){
                settings.removeClass('active');
            }
        } else {
            if(settings.hasClass('active')){
                settings.removeClass('active');
            } else {
                settings.addClass('active');
                toggleInventory('hide');
                toggleShop('hide');
            }
        }
    }
    /**
     * Upgrade Weapon Modal
     */
    function toggleUpgradeModal(visibility){
        var upgradeModal = $('#upgrade-modal');
        if (visibility === 'show') {
            if(!upgradeModal.hasClass('active')){
                upgradeModal.addClass('active');
            }
        } else {
            upgradeModal.removeClass('active');
            renderInventory(state.inventory);
            updatePlayerWeapon(state.player);
            toggleInventory('show');
        }
    }
    /**
     * Actions / Buttons
     */
    // fullscreen
    $(document).on('click', '.toggle-fullscreen', function() {
        var el = document.getElementById('game');
        (el.requestFullscreen) && el.requestFullscreen();
        (el.webkitRequestFullscreen) && el.webkitRequestFullscreen();
        (el.mozRequestFullScreen) && el.mozRequestFullScreen();
        (el.msRequestFullscreen) && el.msRequestFullscreen();
    });
    // Player Attack
    $(document).on('click', '.player-attack', function() {
        var player = state.player;
        var monsterID = $('#battleground > .monster:last-of-type').data('monster');
        var monster = getMonster(monsterID);
        attack(player, monster);
    });
    // Player Potion
    $(document).on('click', '.player-potion', function() {
        var player = state.player;
        var potionVal = Math.floor(player.maxHealth / 4.33);
        if(player.potionCount > 0) {
            if(player.health < player.maxHealth){
                player.health = player.health + potionVal;
                player.potionCount = player.potionCount - 1;
            }
        }
        if(player.health > player.maxHealth){
            player.health = player.maxHealth;
        }
        updatePlayer(player);
        save(state);
    });
    // Game Reset
    $(document).on('click', '#game-reset', function() {
        gameReset();
    });
    // Attack Monster
    $('#battleground').on('click', '.attack-monster', function() {
        var current_monster = $(this).closest('.monster');
        var player = state.player;
        var monsterID = current_monster.data('monster');
        var monster = getMonster(monsterID);
        attack(player, monster);
    });
    // Open Inventory
    $(document).on('click', '.toggle-inventory', function() {
        toggleInventory();
    });
    // Open item in viewer
    $('#inventory').on('click', '.item', function() {
        var weaponID = $(this).data('item-id');
        var weapon = getWeapon(weaponID);
        var viewer = $('#item-viewer');
        renderWeaponViewer(weapon);
    });
    // Equip / Set Item from inventory
    $(document).on('click', '#item-viewer button.equip', function() {
        var weaponID = $(this).data('item-id');
        var weapon = getWeapon(weaponID);
        state.player.weapon = weapon;
        updatePlayerWeapon(state.player);
    });
    // Delete Item from inventory
    $(document).on('click', '#item-viewer button.delete', function() {
        var weaponID = $(this).data('item-id');
        var weapon = getWeapon(weaponID);
        var deleteConfirm = confirm("Are you SURE you want to delete this item?");
        if (deleteConfirm == true) {
            deleteInventoryItem(weapon.id);
        }
    });
    // Upgrade Weapon Modal
    $(document).on('click', '#item-viewer button.upgrade', function() {
        var weaponID = $(this).data('item-id');
        var weapon = getWeapon(weaponID);
        renderUpgradeModal(weapon);
        toggleUpgradeModal('show');
    });
    // Upgrade Weapon Damage
    $(document).on('click', '#upgrade-modal button.upgrade-damage', function() {
        var weaponID = $(this).data('item-id');
        var weapon = getWeapon(weaponID);
        upgradeWeapon(weapon, 1);
    });
    // Upgrade Weapon Crit
    $(document).on('click', '#upgrade-modal button.upgrade-crit', function() {
        var weaponID = $(this).data('item-id');
        var weapon = getWeapon(weaponID);
        upgradeWeapon(weapon, null, 1);
    });
    // Toggle Weapon Modal
    $(document).on('click', '.toggle-upgrade-modal', function() {
        toggleUpgradeModal();
    });
    // Open Settings
    $(document).on('click', '.toggle-settings', function() {
        toggleSettings();
    });
    // Open Shop
    $(document).on('click', '.toggle-shop', function() {
        toggleShop();
    });
    // Purchase Item
    $(document).on('click', '#shop button.purchase', function() {
        var itemType = $(this).data('type');
        var itemID = $(this).data('item-id');
        if (itemType === 'potion') {
            var item = state.shop.potions[itemID];
        } else if (itemType === 'weapon') {
            var item = state.shop.weapons[itemID];
        }
        purchaseItem(item, itemType);
    });



}); // document.ready
</script>
</body>
</html>
